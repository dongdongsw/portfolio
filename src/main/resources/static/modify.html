<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>게시글 수정</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 860px; margin: 24px auto; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; }
    textarea { min-height:160px; }
    .actions { margin-top:16px; display:flex; gap:10px; }
    button { padding:10px 14px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .slots { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
    .slot { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .slot h3 { margin:0 0 8px; font-size:14px; color:#374151; }
    .preview { width:100%; height:160px; object-fit:cover; border-radius:8px; background:#f3f4f6; display:block; }
    .meta { color:#6b7280; margin-bottom:12px; }
  </style>
</head>
<body>
<h1>게시글 수정</h1>
<div class="meta">작성일: <span id="uploaddate">-</span></div>

<form id="form" enctype="multipart/form-data">
  <label>로그인ID</label>
  <input id="loginid_view" type="text" readonly />
  <input id="loginid" name="loginid" type="hidden" />

  <label>닉네임</label>
  <input id="nickname_view" type="text" readonly />
  <input id="nickname" name="nickname" type="hidden" />

  <label for="title">제목</label>
  <input id="title" name="title" required />

  <label for="content">내용</label>
  <textarea id="content" name="content" required></textarea>

  <label>이미지 파일 (최대 5개, 비워두면 기존 유지)</label>
  <div class="slots">
    <div class="slot">
      <h3>이미지 0</h3>
      <img id="preview0" class="preview" alt="image0" onerror="this.style.display='none'">
      <input type="file" id="file0" name="files" accept="image/*" />
    </div>
    <div class="slot">
      <h3>이미지 1</h3>
      <img id="preview1" class="preview" alt="image1" onerror="this.style.display='none'">
      <input type="file" id="file1" name="files" accept="image/*" />
    </div>
    <div class="slot">
      <h3>이미지 2</h3>
      <img id="preview2" class="preview" alt="image2" onerror="this.style.display='none'">
      <input type="file" id="file2" name="files" accept="image/*" />
    </div>
    <div class="slot">
      <h3>이미지 3</h3>
      <img id="preview3" class="preview" alt="image3" onerror="this.style.display='none'">
      <input type="file" id="file3" name="files" accept="image/*" />
    </div>
    <div class="slot">
      <h3>이미지 4</h3>
      <img id="preview4" class="preview" alt="image4" onerror="this.style.display='none'">
      <input type="file" id="file4" name="files" accept="image/*" />
    </div>
  </div>

  <div class="actions">
    <button type="submit">수정</button>
    <button type="button" onclick="location.href='detail.html?id='+postId">취소</button>
  </div>
</form>

<script>
  const API_BASE = "http://localhost:8080";
  const postId = new URLSearchParams(location.search).get("id");

  // 파일 선택 시 미리보기
  function bindPreview(inputId, imgId) {
    const input = document.getElementById(inputId);
    const img = document.getElementById(imgId);
    input.addEventListener('change', () => {
      if (input.files && input.files[0]) {
        img.src = URL.createObjectURL(input.files[0]);
        img.style.display = 'block';
      }
    });
  }
  for (let i = 0; i < 5; i++) bindPreview('file' + i, 'preview' + i);

  // 기존 데이터 채우기 (수정일은 표시 안 함)
  fetch(`${API_BASE}/api/posts/detail/${postId}`)
    .then(r => r.json())
    .then(p => {
      document.getElementById('uploaddate').textContent = p.uploaddate || '-';
      document.getElementById('loginid_view').value = p.loginid || '';
      document.getElementById('nickname_view').value = p.nickname || '';
      document.getElementById('loginid').value = p.loginid || '';
      document.getElementById('nickname').value = p.nickname || '';
      document.getElementById('title').value = p.title || '';
      document.getElementById('content').value = p.content || '';

      // 기존 이미지 프리뷰 (캐시 방지 쿼리)
      const paths = [p.imagepath0, p.imagepath1, p.imagepath2, p.imagepath3, p.imagepath4];
      paths.forEach((src, i) => {
        if (src) {
          const img = document.getElementById('preview' + i);
          img.src = src + `?v=${Date.now()}`;
          img.style.display = 'block';
        }
      });
    });

  // 제출 → 수정 완료 후 detail로 이동(그때 수정일 보임)
  const form = document.getElementById('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form); // files(0~4) + title + content + loginid + nickname

    const res = await fetch(`${API_BASE}/api/posts/modify/${postId}`, {
      method: 'PUT',
      body: fd
    });
    if (!res.ok) {
      alert(await res.text() || '수정 실패');
      return;
    }
    alert('수정 완료');
    location.href = `detail.html?id=${postId}`;
  });
</script>
</body>
</html>
