<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 및 이미지 업로드</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        h1, h2 { color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="file"] { margin-bottom: 10px; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #45a049; }
        .response-box { margin-top: 20px; padding: 15px; background-color: #e9e9e9; border-radius: 4px; border: 1px solid #ddd; word-break: break-all; }
        .error-message { color: red; margin-top: 10px; }
        .post-item { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f9f9f9; }
        .post-item h3 { margin-top: 0; color: #0056b3; }
        .post-item img { max-width: 150px; height: auto; margin-right: 10px; border: 1px solid #eee; }
        .image-container { display: flex; flex-wrap: wrap; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>새 게시글 작성</h1>

    <form id="postForm" enctype="multipart/form-data">
        <label for="title">제목:</label>
        <input type="text" id="title" name="title" required>

        <label for="loginid">로그인 ID:</label>
        <input type="text" id="loginid" name="loginid" required>

        <label for="nickname">닉네임:</label>
        <input type="text" id="nickname" name="nickname">

        <label for="content">내용:</label>
        <textarea id="content" name="content" rows="5"></textarea>

        <label>이미지 파일 (최대 5개):</label>
        <input type="file" name="files" accept="image/*"><br>
        <input type="file" name="files" accept="image/*"><br>
        <input type="file" name="files" accept="image/*"><br>
        <input type="file" name="files" accept="image/*"><br>
        <input type="file" name="files" accept="image/*"><br>

        <button type="submit">게시글 작성</button>
    </form>

    <div id="response" class="response-box">
        서버 응답: <span id="responseMessage"></span>
    </div>
    <div id="errorMessage" class="error-message"></div>

    <h2>게시글 전체 조회</h2>
    <button onclick="getAllPosts()">모든 게시글 불러오기</button>
    <div id="allPosts" class="response-box">
        <!-- 게시글 목록이 여기에 표시됩니다 -->
    </div>
</div>

<script>
    document.getElementById('postForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // 폼 기본 제출 방지

        const formData = new FormData(this); // 폼 데이터 객체 생성

        try {
            // Spring Boot 서버의 절대 URL로 요청 (포트 주의)
            const response = await fetch('http://localhost:8080/api/posts', {
                method: 'POST',
                body: formData // FormData는 Content-Type: multipart/form-data를 자동으로 설정
            });

            if (response.ok) {
                const result = await response.text(); // 서버가 String을 반환하므로 text() 사용
                document.getElementById('responseMessage').textContent = result;
                document.getElementById('errorMessage').textContent = '';
                alert('게시글 작성이 완료되었습니다!');
                document.getElementById('postForm').reset(); // 폼 초기화
                getAllPosts(); // 작성 후 전체 목록 다시 불러오기
            } else {
                const errorText = await response.text();
                document.getElementById('responseMessage').textContent = '';
                document.getElementById('errorMessage').textContent = `오류 발생: ${errorText || response.statusText}`;
                alert('게시글 작성에 실패했습니다.');
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            document.getElementById('responseMessage').textContent = '';
            document.getElementById('errorMessage').textContent = `네트워크 오류 또는 서버 접속 실패: ${error.message}`;
            alert('네트워크 오류가 발생했습니다.');
        }
    });

    async function getAllPosts() {
        try {
            // Spring Boot 서버의 절대 URL로 요청 (포트 주의)
            const response = await fetch('http://localhost:8080/api/posts', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json' // JSON 응답을 원함을 명시
                }
            });

            if (response.ok) {
                const posts = await response.json();
                const postsDiv = document.getElementById('allPosts');
                postsDiv.innerHTML = ''; // 기존 목록 초기화

                if (posts.length === 0) {
                    postsDiv.textContent = '아직 작성된 게시글이 없습니다.';
                } else {
                    posts.forEach(post => {
                        const postItem = document.createElement('div');
                        postItem.className = 'post-item';

                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'image-container';

                        // imagepathX 필드에 웹 접근 가능한 이미지 URL이 들어있다고 가정
                        const imagePaths = [
                            post.imagepath0,
                            post.imagepath1,
                            post.imagepath2,
                            post.imagepath3,
                            post.imagepath4
                        ];

                        imagePaths.forEach((imagePath, index) => {
                            if (imagePath) {
                                const img = document.createElement('img');
                                img.src = imagePath; // URL 경로를 직접 img.src에 할당
                                img.alt = `이미지 ${index + 1}`;
                                img.style.maxWidth = '150px';
                                img.style.marginRight = '10px';
                                imageContainer.appendChild(img);
                            }
                        });

                        postItem.innerHTML = `
                            <h3>${post.title} (ID: ${post.id})</h3>
                            <p><strong>작성자:</strong> ${post.nickname || post.loginid}</p>
                            <p><strong>내용:</strong> ${post.content}</p>
                            <p><strong>조회수:</strong> ${post.viewcount}</p>
                            <p><strong>작성일:</strong> ${new Date(post.uploaddate).toLocaleString()}</p>
                            <p><strong>수정일:</strong> ${new Date(post.modifydate).toLocaleString()}</p>
                        `;
                        postItem.appendChild(imageContainer);
                        postsDiv.appendChild(postItem);
                    });
                }
            } else {
                console.error('Failed to fetch posts:', response.statusText);
                document.getElementById('allPosts').textContent = `게시글 조회 오류: ${response.statusText}`;
            }
        } catch (error) {
            console.error('Network or fetch error:', error);
            document.getElementById('allPosts').textContent = `네트워크 오류: ${error.message}`;
        }
    }

    // 페이지 로드 시 모든 게시글 자동으로 불러오기
    window.onload = getAllPosts;
</script>
</body>
</html>