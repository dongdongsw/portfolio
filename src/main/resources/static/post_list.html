<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>게시글 목록</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
    h1 { margin-top: 0; }
    .topbar { display: flex; gap: 10px; margin-bottom: 16px; }
    .btn { background-color: #4CAF50; color: #fff; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer; }
    .btn:hover { background-color: #45a049; }
    .post-item { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f9f9f9; }
    .post-item h3 { margin-top: 0; color: #0056b3; }
    .image-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .post-item img { max-width: 150px; height: auto; border: 1px solid #eee; }
    .meta { color: #555; font-size: 14px; }
    .actions { margin-top: 10px; display: flex; gap: 8px; }
    .btn-danger { background-color: #d9534f; }
    .btn-danger:hover { background-color: #c9302c; }
    .response-box { margin-top: 16px; padding: 12px; background-color: #e9e9e9; border-radius: 4px; border: 1px solid #ddd; word-break: break-all; }
  </style>
</head>
<body>
<div class="container">
  <h1>게시글 목록</h1>
  <div class="topbar">
    <button class="btn" onclick="location.href='post_create.html'">새 게시글 작성</button>
    <button class="btn" onclick="loadPosts()">새로고침</button>
  </div>

  <div id="listBox" class="response-box">로딩 중…</div>
</div>

<script>
  const API_BASE = 'http://localhost:8080';

  function fmtDate(s) {
    if (!s) return '-';
    const d = new Date(s);
    return isNaN(d.getTime()) ? s : d.toLocaleString();
  }

  async function loadPosts() {
    const box = document.getElementById('listBox');
    box.textContent = '로딩 중…';
    try {
      const res = await fetch(`${API_BASE}/api/posts/post_list`, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(res.statusText);
      const posts = await res.json();

      if (!Array.isArray(posts) || posts.length === 0) {
        box.textContent = '아직 작성된 게시글이 없습니다.';
        return;
      }

      box.innerHTML = '';
      posts.forEach(post => {
        const item = document.createElement('div');
        item.className = 'post-item';

        const images = [post.imagepath0, post.imagepath1, post.imagepath2, post.imagepath3, post.imagepath4].filter(Boolean);
        const imgWrap = document.createElement('div');
        imgWrap.className = 'image-container';
        images.forEach((src, idx) => {
          const img = document.createElement('img'); img.src = src; img.alt = `이미지 ${idx+1}`; imgWrap.appendChild(img);
        });

        item.innerHTML = `
          <h3>${post.title} (ID: ${post.id})</h3>
          <div class="meta">
            <div><strong>작성자:</strong> ${post.nickname || post.loginid || '-'}</div>
            <div><strong>조회수:</strong> ${post.viewcount ?? 0}</div>
            <div><strong>작성일:</strong> ${fmtDate(post.uploaddate)}</div>
            <div><strong>수정일:</strong> ${fmtDate(post.modifydate)}</div>
          </div>
          <p>${post.content ?? ''}</p>
        `;
        item.appendChild(imgWrap);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn';
        editBtn.textContent = '수정';
        editBtn.onclick = () => location.href = `post_edit.html?id=${post.id}`;

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-danger';
        delBtn.textContent = '삭제';
        delBtn.onclick = () => deletePost(post.id);

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        item.appendChild(actions);

        box.appendChild(item);
      });
    } catch (e) {
      box.textContent = `오류: ${e.message}`;
      console.error(e);
    }
  }

  async function deletePost(id) {
    if (!confirm(`정말 삭제할까요? (ID: ${id})`)) return;
    try {
      const res = await fetch(`${API_BASE}/api/posts/post_delete/${id}`, { method: 'POST' });
      if (!res.ok) throw new Error(await res.text());
      alert('삭제 완료');
      loadPosts();
    } catch (e) {
      alert('삭제 실패: ' + e.message);
      console.error(e);
    }
  }

  window.onload = loadPosts;
</script>
</body>
</html>
